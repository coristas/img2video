#!/usr/bin/python2

# All the images need to be consistent in their resolutions
# before encoding.


import optparse, os, sys, random, subprocess, tempfile, mad, fractions, shutil

FRAMES_PER_SEC = 25
DEFAULT_OUTPUT_FILE = 'out.avi'

def process(pics, mp3, outfile):
    frames = mp3_length(mp3) * FRAMES_PER_SEC
    if len(pics) > frames:
        raise RuntimeError('The number of pictures must not exceed '
                           'the target number of frames')
    startframe = 0
    picdir = tempfile.mkdtemp(prefix='img2video')
    try:
        createsymlinks(pics, frames, picdir)
        encode(mp3, outfile, picdir)
    finally:
        shutil.rmtree(picdir)

def mp3_length(mp3):
    return mad.MadFile(mp3).total_time() / 1000

def process_pic(pic, picdir):
    # trololo...
    return os.path.abspath(pic)

def createsymlinks(pics, frames, picdir):
    framesperpic = fractions.Fraction(frames, len(pics))
    startframe = 0
    crntdir = os.getcwd()
    for pic in pics:
        pic = process_pic(pic, picdir)
        for i in xrange(int(startframe), int(startframe + framesperpic)):
            os.symlink(pic, '%s/frame%d.jpg' % (picdir, i))
        startframe += framesperpic

def encode(mp3, outfile, picdir):
    subprocess.call(["ffmpeg",
                     "-r", str(FRAMES_PER_SEC),
                     "-i", picdir + '/frame%d.jpg', "-i", mp3,
                     "-vcodec", "ffv1","-b", "500k", "-acodec","copy",
                     outfile])


def main():
    parser = optparse.OptionParser(usage="%prog [-s] [o OUTFILE] MP3 IMAGE...")
    parser.add_option('-s', '--shuffle', dest='shuffle',
                      default=False, action='store_true',
                      help='shuffle images before encoding')
    parser.add_option('-o', '--output', dest='output',
                      help='output file name, defaults to out.avi')
    options, args = parser.parse_args()
    if len(args) < 2:
        parser.print_usage(sys.stderr)
        sys.exit(2)
    mp3 = args[0]
    pics = args[1:]
    if options.shuffle:
        random.shuffle(pics)
    process(pics, mp3, options.output or DEFAULT_OUTPUT_FILE)

if __name__ == '__main__':
    main()
